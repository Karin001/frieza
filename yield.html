<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>

<body>

    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script>
        const Frieza = (function () {
            var state = 1;
            return {
                chargingFlag: false,
                troubleMaker: function () {
                    return Math.random() < 0.2
                },
                stateReset: function () {
                    state = 1;
                },
                
                change: function (callback) {

                    if (this.chargingFlag === true) {
                        throw new Error(`弗利萨还没变身完毕呢`);
                    }
                    this.chargingFlag = true;
                    console.log(`弗利萨开始进行第${state + 1}形态变身`)
                    setTimeout(() => {
                        if (this.troubleMaker()) {
                            this.stateReset();
                            this.chargingFlag = false;
                            callback('变身被悟空打断啦！');
                            return;
                        }
                        state++;
                        this.chargingFlag = false;
                        callback(null, state);
                    }, 1000)
                }

            }
        })();
        // promise
        function keepChange() {
            return new Promise((resolve, reject) => {
                Frieza.change((err, state) => {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(state);
                    }
                })
            })
        }
        function handelKeepChange() {
            keepChange().then((x) => {
             if(x !== 8){
                handelKeepChange();
             } else {
                 console.log('成功！')
             }
        }).catch(err => {
            console.log(err);
            handelKeepChange();
        })
        }
       handelKeepChange();
       console.log('hahaha');
       console.log('hahaha');
       console.log('hahaha');
       console.log('hahaha');
       console.log('hahaha');
        // generator + promise
        /* function* async(){
            yield changeHandle();
            ;
        } */
    </script>
</body>

</html>