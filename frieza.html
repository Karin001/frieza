<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/@reactivex/rxjs@5.0.3/dist/global/Rx.js"></script>
    <script>
        const dragonBall = new Rx.Subject();

        const Frieza = (function () {
            var state = 1;
            return {
                chargingFlag: false,
                damage: function () {
                    return Math.random() < 0.1;
                },
                stateReset: function () {
                    state = 1;
                },
                getState: function () {
                    return state;
                },
                change: function () {

                    if (this.chargingFlag === true) {
                        drangonBall.next(new Error('变身还没结束呢！'))
                    }
                    this.chargingFlag = true;
                    console.log(`弗利萨开始进行第${state + 1}形态变身`)
                    setTimeout(() => {
                        if (this.damage()) {
                            this.stateReset();
                            this.chargingFlag = false;
                            dragonBall.next(new Error('变身被悟空打断啦！'));
                            return;
                        }
                        state++;
                        this.chargingFlag = false;
                        dragonBall.next(`${state}形态变身成功！`)
                    }, 1000)
                }

            }
        })();

        const watchAnime = dragonBall.asObservable()
            
            .subscribe(message => {
                console.log(message);
                
                if (Frieza.getState() !== 8) {
                    Frieza.change();
                } else {
                    watchAnime.unsubscribe();
                }

            })

        Frieza.change();


    </script>
</body>

</html>