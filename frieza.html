<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script>
        const Frieza = (function () {
            var state = 1;
            return {
                chargingFlag: false,
                damage: function () {
                    return Math.random() < 0.2;
                },
                stateReset: function () {
                    state = 1;
                },
                getState: function () {
                    return state;
                },
                change: function (callback) {

                    if (this.chargingFlag === true) {
                        throw new Error(`弗利萨还没变身完毕呢`);
                    }
                    this.chargingFlag = true;
                    console.log(`弗利萨开始进行第${state + 1}形态变身`)
                    setTimeout(() => {
                        if (this.damage()) {
                            this.stateReset();
                            this.chargingFlag = false;
                            callback(new Error('变身被悟空打断啦！'));
                            return;
                        }
                        state++;
                        this.chargingFlag = false;
                        callback(null, state);
                    }, 1000)
                }

            }
        })();
        // generator + promise

         function* async() {
            while (Frieza.getState() !== 8) {
                yield keepChange();
            }
            console.log('成功！');
        }
        function keepChange() {
            return new Promise((resolve, reject) => {
                Frieza.change((err, state) => {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(state);
                    }
                })
            })
        }
        function handleAsync(asyncFn) {
            const ita = asyncFn();
            function handle(v) {
                if (!v.done) {
                    v.value.then(state => {
                        handle(ita.next(state));
                    }).catch(err => {
                        console.log(err);
                        handle(ita.next());
                    })
                }
            }
            handle(ita.next());
        }
        handleAsync(async);



    </script>
</body>

</html>